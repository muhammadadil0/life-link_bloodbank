{% extends "base.html" %}

{% block title %}Donor Dashboard - LifeLink{% endblock %}

{% block extra_head %}
<style>
    /* Animated Blood Drop Balls (background) */
    .blood-ball {
        position: absolute;
        background: radial-gradient(circle at 60% 40%, #ef4444 70%, #b91c1c 100%);
        border-radius: 50% 50% 60% 40% / 60% 40% 50% 50%;
        opacity: 0.13;
        filter: blur(2px);
        animation: blood-float 10s ease-in-out infinite;
    }
    @keyframes blood-float {
        0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
        20% { transform: translateY(-30px) scale(1.08) rotate(8deg); }
        50% { transform: translateY(40px) scale(0.95) rotate(-6deg); }
        80% { transform: translateY(-15px) scale(1.05) rotate(4deg); }
    }
    .glass-card {
        background: rgba(255,255,255,0.85);
        backdrop-filter: blur(18px);
        border: 1px solid rgba(255,255,255,0.25);
        border-radius: 24px;
        box-shadow: 0 10px 40px rgba(220,38,38,0.08), 0 4px 12px rgba(0,0,0,0.04);
        transition: all 0.4s cubic-bezier(.4,0,.2,1);
    }
    .glass-card:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 40px rgba(220,38,38,0.15), 0 8px 24px rgba(0,0,0,0.08);
    }
    .fade-in-up { opacity: 0; transform: translateY(30px); transition: all 0.8s cubic-bezier(0.25,0.46,0.45,0.94); }
    .fade-in-up.visible { opacity: 1; transform: translateY(0); }
</style>
{% endblock %}

{% block content %}
<!-- Animated Blood Drop Balls Background (Global) -->
<div class="fixed inset-0 -z-10 pointer-events-none">
    <div class="blood-ball" style="top: 8%; left: 6%; width: 90px; height: 90px; animation-delay: 0s;"></div>
    <div class="blood-ball" style="top: 65%; left: 12%; width: 70px; height: 70px; animation-delay: 2s;"></div>
    <div class="blood-ball" style="top: 25%; left: 80%; width: 110px; height: 110px; animation-delay: 1.5s;"></div>
    <div class="blood-ball" style="top: 78%; left: 72%; width: 80px; height: 80px; animation-delay: 3s;"></div>
    <div class="blood-ball" style="top: 52%; left: 48%; width: 120px; height: 120px; animation-delay: 4s;"></div>
    <div class="blood-ball" style="top: 40%; left: 30%; width: 100px; height: 100px; animation-delay: 2.5s;"></div>
</div>

<div class="container mx-auto px-4 py-12 fade-in-up">
    <!-- Welcome Section -->
    <div class="mb-10 text-center">
        <div class="inline-block glass-card px-12 py-8 mb-6 fade-in-up">
            <div class="w-20 h-20 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="user" class="w-10 h-10 text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-900 mb-2">Welcome back, {{ donor_data.name }}!</h1>
            <p class="text-lg text-gray-600 mb-2">Thank you for being a life-saver in your community</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center mt-4">
                <div class="bg-green-100 text-green-700 px-4 py-2 rounded-full text-base font-medium inline-flex items-center">
                    <i data-lucide="check-circle" class="w-5 h-5 mr-2"></i>
                    Available to Donate
                </div>
                <div class="bg-blue-100 text-blue-700 px-4 py-2 rounded-full text-base font-medium inline-flex items-center">
                    <i data-lucide="droplets" class="w-5 h-5 mr-2"></i>
                    Blood Group: {{ donor_data.blood_type }}
                </div>
                <div class="bg-pink-100 text-pink-700 px-4 py-2 rounded-full text-base font-medium inline-flex items-center">
                    <i data-lucide="phone" class="w-5 h-5 mr-2"></i>
                    {{ donor_data.phone }}
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid md:grid-cols-4 gap-6 mb-12 fade-in-up">
        <div class="glass-card p-6 text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i data-lucide="droplets" class="w-6 h-6 text-blue-500"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900">{{ donor_data.blood_type }}</div>
            <div class="text-sm text-gray-600">Blood Group</div>
        </div>
        <div class="glass-card p-6 text-center">
            <div class="w-12 h-12 bg-pink-100 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i data-lucide="heart" class="w-6 h-6 text-pink-500"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900">{{ donor_data.age }}</div>
            <div class="text-sm text-gray-600">Age</div>
        </div>
        <div class="glass-card p-6 text-center">
            <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i data-lucide="bell" class="w-6 h-6 text-orange-500"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900">{{ donor_data.phone }}</div>
            <div class="text-sm text-gray-600">Phone</div>
        </div>
        <div class="glass-card p-6 text-center">
            <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-4">
                <i data-lucide="calendar" class="w-6 h-6 text-blue-500"></i>
            </div>
            <div class="text-2xl font-bold text-gray-900">{{ donor_data.address }}</div>
            <div class="text-sm text-gray-600">Address</div>
        </div>
    </div>

    <!-- Emergency Requests -->
    <section class="fade-in-up">
        <div class="glass-card p-8 mb-8">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-red-500"></i>
                        Emergency Blood Requests
                    </h2>
                    <p class="text-gray-600">Urgent requests matching your blood group in your area</p>
                </div>
                <div class="bg-red-100 text-red-700 px-4 py-2 rounded-full text-base font-medium">
                    {{ emergency_requests|length }} Active
                </div>
            </div>
            <div class="grid md:grid-cols-2 gap-8">
                {% for request in emergency_requests %}
                <div class="glass-card border-l-4 border-red-500 p-6 fade-in-up">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-gray-900 text-xl">{{ request.patient_name }}</h4>
                            <p class="text-sm text-gray-600">{{ request.hospital }}</p>
                        </div>
                        <div class="bg-red-500 text-white px-3 py-1 rounded-full text-sm font-medium">
                            {{ request.urgency }}
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                        <div>
                            <span class="text-gray-600">Blood Group:</span>
                            <div class="font-medium flex items-center gap-1">
                                <i data-lucide="droplets" class="w-3 h-3 text-red-500"></i>
                                {{ request.blood_type }}
                            </div>
                        </div>
                        <div>
                            <span class="text-gray-600">Units Needed:</span>
                            <div class="font-medium">{{ request.units_needed }}</div>
                        </div>
                        <div>
                            <span class="text-gray-600">City:</span>
                            <div class="font-medium">{{ request.city }}</div>
                        </div>
                        <div>
                            <span class="text-gray-600">Posted:</span>
                            <div class="font-medium">{{ request.created_at.strftime('%b %d, %H:%M') }}</div>
                        </div>
                        <div>
                            <span class="text-gray-600">Contact:</span>
                            <div class="font-medium">{{ request.contact }}</div>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <a href="https://www.google.com/maps/search/?api=1&query={{ (request.hospital ~ ' ' ~ request.city) | urlencode }}" target="_blank" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-1"></i>
                            Directions
                        </a>
                        <button onclick="openChatModal({{ session['user_id'] }}, '{{ session['user_type'] }}', {{ request.patient_id if request.patient_id else 0 }}, 'patient', '{{ request.patient_name }}')" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center justify-center">
                            <i data-lucide="message-circle" class="w-4 h-4 mr-1"></i>
                            Chat
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
</div>

<!-- Chat Modal and JS (reuse from patient_landing.html if not present) -->
<div id="chatModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-4">
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-bold text-lg" id="chatWith"></h3>
      <button onclick="closeChatModal()" class="text-gray-500">&times;</button>
    </div>
    <div id="chatMessages" class="h-64 overflow-y-auto border rounded p-2 mb-2 bg-gray-50"></div>
    <div class="flex">
      <input id="chatInput" type="text" class="flex-1 border rounded-l px-2 py-1" placeholder="Type a message..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="bg-red-500 text-white px-4 rounded-r">Send</button>
    </div>
  </div>
</div>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
let socket = io();
let currentRoom = '';
let myId = {{ session['user_id'] }};
let myType = '{{ session['user_type'] }}';
let chatWithId = null;
let chatWithType = null;
function openChatModal(senderId, senderType, receiverId, receiverType, receiverName) {
    document.getElementById('chatModal').classList.remove('hidden');
    document.getElementById('chatWith').innerText = 'Chat with ' + receiverName;
    chatWithId = receiverId;
    chatWithType = receiverType;
    let ids = [senderId + '-' + senderType, receiverId + '-' + receiverType].sort().join('-');
    currentRoom = ids;
    socket.emit('join_room', {room: currentRoom});
    loadChatHistory(senderId, senderType, receiverId, receiverType);
}
function closeChatModal() {
    document.getElementById('chatModal').classList.add('hidden');
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('chatInput').value = '';
}
function sendMessage() {
    let msg = document.getElementById('chatInput').value.trim();
    if (!msg) return;
    socket.emit('send_message', {
        sender_id: myId,
        sender_type: myType,
        receiver_id: chatWithId,
        receiver_type: chatWithType,
        message: msg,
        room: currentRoom
    });
    document.getElementById('chatInput').value = '';
}
socket.on('receive_message', function(data) {
    console.log('Received message:', data); // Debugging line
    
    // Only show notification if the current user is the recipient
    if (myId == data.receiver_id && myType == data.receiver_type) {
        // Always show browser notification with sound and title flash
        showNotification(data.sender_name, data.message);
        
        // Show toastr notification
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "positionClass": "toast-top-center",
                "timeOut": "5000"
            };
            toastr.info('New message from ' + data.sender_name + ': ' + data.message);
        }
    }
    let chatBox = document.getElementById('chatMessages');
    let isMine = (data.sender_id == myId && data.sender_type == myType);
    let align = isMine ? 'text-right' : 'text-left';
    let color = isMine ? 'bg-red-100' : 'bg-gray-200';
    chatBox.innerHTML += `<div class="my-1 ${align}"><span class="inline-block ${color} px-2 py-1 rounded">${data.message}</span><br><span class="text-xs text-gray-400">${data.timestamp}</span></div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
});
function loadChatHistory(senderId, senderType, receiverId, receiverType) {
    fetch(`/chat/history?user1=${senderId}&type1=${senderType}&user2=${receiverId}&type2=${receiverType}`)
        .then(res => res.json())
        .then(data => {
            let chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = '';
            data.forEach(msg => {
                let isMine = (msg.sender_id == myId && msg.sender_type == myType);
                let align = isMine ? 'text-right' : 'text-left';
                let color = isMine ? 'bg-red-100' : 'bg-gray-200';
                chatBox.innerHTML += `<div class="my-1 ${align}"><span class="inline-block ${color} px-2 py-1 rounded">${msg.message}</span><br><span class="text-xs text-gray-400">${msg.timestamp}</span></div>`;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}
</script>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Fade-in animation for cards and sections
    const fadeEls = document.querySelectorAll('.fade-in-up');
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
            }
        });
    }, { threshold: 0.1 });
    fadeEls.forEach(el => observer.observe(el));
});
</script>
{% endblock %}