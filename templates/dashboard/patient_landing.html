{% extends "base.html" %}

{% block title %}Patient Portal - LifeLink{% endblock %}

{% block extra_head %}
<style>
    .glass-card {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.3);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(220,38,38,0.08), 0 4px 12px rgba(0,0,0,0.04);
        transition: all 0.4s cubic-bezier(.4,0,.2,1);
    }
    .glass-card:hover {
        transform: translateY(-8px) scale(1.03);
        box-shadow: 0 20px 40px rgba(220,38,38,0.15), 0 8px 24px rgba(0,0,0,0.08);
    }
    .btn-medical {
        background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
        color: white;
        font-weight: 600;
        border-radius: 12px;
        padding: 12px 32px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.3);
    }
    .btn-medical:hover {
        background: linear-gradient(135deg, #b91c1c 0%, #dc2626 100%);
        transform: translateY(-2px);
        box-shadow: 0 12px 30px rgba(220, 38, 38, 0.4);
    }
    /* Animated Blood Drop Balls (background) */
    .blood-ball {
        position: absolute;
        background: radial-gradient(circle at 60% 40%, #ef4444 70%, #b91c1c 100%);
        border-radius: 50% 50% 60% 40% / 60% 40% 50% 50%;
        opacity: 0.13;
        filter: blur(2px);
        animation: blood-float 10s ease-in-out infinite;
    }
    @keyframes blood-float {
        0%, 100% { transform: translateY(0) scale(1) rotate(0deg); }
        20% { transform: translateY(-30px) scale(1.08) rotate(8deg); }
        50% { transform: translateY(40px) scale(0.95) rotate(-6deg); }
        80% { transform: translateY(-15px) scale(1.05) rotate(4deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Animated Blood Drop Balls Background (Global) -->
<div class="fixed inset-0 -z-10 pointer-events-none">
    <div class="blood-ball" style="top: 8%; left: 6%; width: 90px; height: 90px; animation-delay: 0s;"></div>
    <div class="blood-ball" style="top: 65%; left: 12%; width: 70px; height: 70px; animation-delay: 2s;"></div>
    <div class="blood-ball" style="top: 25%; left: 80%; width: 110px; height: 110px; animation-delay: 1.5s;"></div>
    <div class="blood-ball" style="top: 78%; left: 72%; width: 80px; height: 80px; animation-delay: 3s;"></div>
    <div class="blood-ball" style="top: 52%; left: 48%; width: 120px; height: 120px; animation-delay: 4s;"></div>
    <div class="blood-ball" style="top: 40%; left: 30%; width: 100px; height: 100px; animation-delay: 2.5s;"></div>
</div>

<div class="container mx-auto px-4 py-16 fade-in-up">
    <!-- Hero Section -->
    <section class="mb-16 text-center">
        <div class="glass-card p-12 max-w-3xl mx-auto mb-8">
            <h1 class="text-5xl font-bold font-display mb-4 bg-gradient-to-r from-gray-900 via-red-600 to-gray-900 bg-clip-text text-transparent">Welcome to the Patient Portal</h1>
            <p class="text-xl text-gray-700 mb-6">Your health and hope matter. Here you can request blood, track your requests, and connect with donors in your area.</p>
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <a href="{{ url_for('emergency.create_emergency') }}" class="btn-medical inline-flex items-center justify-center">
                    <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                    Request Blood Now
                </a>
                <a href="{{ url_for('main.donors') }}" class="btn-medical inline-flex items-center justify-center">
                    <i data-lucide="users" class="w-5 h-5 mr-2"></i>
                    View Donors
                </a>
            </div>
        </div>
        <div class="w-full max-w-2xl mx-auto bg-white/90 rounded-2xl shadow-lg p-8 border-l-8 border-red-500 relative overflow-hidden fade-in-up">
            <h2 class="text-2xl font-bold mb-4 text-red-600 font-display">How LifeLink Helps Patients</h2>
            <ul class="text-gray-700 text-lg leading-relaxed mb-4 list-disc list-inside text-left mx-auto" style="max-width: 600px;">
                <li>
                    Request blood easily and quickly in emergencies<br>
                    <span dir="rtl" class="block text-base text-gray-600">ہنگامی صورتحال میں آسانی اور تیزی سے خون کی درخواست کریں</span>
                </li>
                <li>
                    Track the status of your requests in real time<br>
                    <span dir="rtl" class="block text-base text-gray-600">اپنی درخواستوں کی صورتحال کو حقیقی وقت میں ٹریک کریں</span>
                </li>
                <li>
                    Connect with verified donors nearby<br>
                    <span dir="rtl" class="block text-base text-gray-600">اپنے قریب تصدیق شدہ ڈونرز سے رابطہ کریں</span>
                </li>
                <li>
                    Access support and resources for your health journey<br>
                    <span dir="rtl" class="block text-base text-gray-600">اپنے صحت کے سفر کے لیے معاونت اور وسائل تک رسائی حاصل کریں</span>
                </li>
            </ul>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="mb-16">
        <div class="grid md:grid-cols-3 gap-6 text-center">
            <div class="glass-card p-8">
                <div class="text-4xl font-bold mb-2">{{ active_donor_count }}</div>
                <div class="text-green-500">Active Donors</div>
            </div>
            <div class="glass-card p-8">
                <div class="text-4xl font-bold mb-2">98%</div>
                <div class="text-orange-500">Success Rate</div>
            </div>
            <div class="glass-card p-8">
                <div class="text-4xl font-bold mb-2">24/7</div>
                <div class="text-purple-500">Support</div>
            </div>
        </div>
    </section>

    <!-- Active Donors List Section -->
    <section class="mb-16">
        <div class="glass-card p-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 flex items-center gap-2">
                <i data-lucide="users" class="w-5 h-5 text-blue-500"></i>
                Active Donors
            </h2>
            {% if donors %}
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                {% for donor in donors %}
                <div class="relative bg-white rounded-2xl shadow-xl border-l-8 border-red-400 p-8 flex flex-col items-start" style="min-width:300px;">
                    <div class="flex items-center w-full mb-4">
                        <div class="w-16 h-16 bg-gradient-to-br from-red-500 to-pink-600 rounded-full flex items-center justify-center mr-4">
                            <i data-lucide="user" class="w-8 h-8 text-white"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2">
                                <h3 class="text-xl font-bold text-gray-900">{{ donor.name }}</h3>
                                {% if donor.email %}<span class="text-gray-400 text-xs">{{ donor.email }}</span>{% endif %}
                            </div>
                            <div class="mt-1">
                                <span class="inline-flex items-center px-3 py-1 rounded-lg text-white font-semibold bg-gradient-to-r from-red-500 to-pink-500 text-sm">
                                    <i data-lucide="droplet" class="w-4 h-4 mr-1"></i>{{ donor.blood_type }}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-wrap gap-8 w-full mb-4 mt-2">
                        <div class="flex items-center gap-2 text-gray-500 text-sm">
                            <i data-lucide="calendar" class="w-4 h-4"></i>
                            <span>Age</span>
                            <span class="text-gray-900 font-semibold ml-1">{{ donor.age }}</span>
                        </div>
                        <div class="flex items-center gap-2 text-gray-500 text-sm">
                            <i data-lucide="phone" class="w-4 h-4"></i>
                            <span>Phone</span>
                            <span class="text-gray-900 font-semibold ml-1">{{ donor.phone }}</span>
                        </div>
                    </div>
                    <div class="flex items-start gap-2 text-gray-500 text-sm mb-4">
                        <i data-lucide="map-pin" class="w-4 h-4 mt-1"></i>
                        <div>
                            <span class="font-semibold text-gray-700">Address</span><br>
                            <span class="text-gray-900">{{ donor.address }}</span>
                        </div>
                    </div>
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-3 h-3 rounded-full bg-green-500 inline-block"></span>
                        <span class="text-green-600 font-semibold text-sm">Available</span>
                    </div>
                    <div class="flex gap-3 w-full mt-2">
                        <a href="tel:{{ donor.phone }}" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center transition-colors">
                            <i data-lucide="phone" class="w-4 h-4 mr-2"></i>Contact
                        </a>
                        <a href="https://www.google.com/maps/search/?api=1&query={{ donor.address|urlencode }}" target="_blank" class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center transition-colors">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-2"></i>Directions
                        </a>
                        <button class="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg font-semibold flex items-center justify-center transition-colors" onclick="openChatModal({{ session['user_id'] }}, '{{ session['user_type'] }}', {{ donor.id }}, 'donor', '{{ donor.name }}')">
                            <i data-lucide="message-circle" class="w-4 h-4 mr-2"></i>Chat
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="text-center text-gray-500 py-8">No active donors found at the moment.</div>
            {% endif %}
        </div>
    </section>

    <!-- Call to Action Section -->
    <section class="mb-16 text-center">
        <div class="glass-card p-10 max-w-2xl mx-auto">
            <h2 class="text-3xl font-bold mb-4 text-gray-900">Need Blood Urgently?</h2>
            <p class="text-lg text-gray-700 mb-6">Submit a request and our network will connect you with available donors in minutes.</p>
            <a href="{{ url_for('emergency.create_emergency') }}" class="btn-medical inline-flex items-center justify-center">
                <i data-lucide="alert-triangle" class="w-5 h-5 mr-2"></i>
                Request Blood
            </a>
        </div>
    </section>

    <!-- Motivational Section -->
    <section class="mb-16">
        <div class="glass-card p-10 max-w-3xl mx-auto text-center">
            <h2 class="text-2xl font-bold mb-4 text-red-600 font-display">You Are Not Alone</h2>
            <p class="text-lg text-gray-700 mb-4">LifeLink is here to support you every step of the way. Our community of donors and volunteers is ready to help you in your time of need.</p>
            <div class="mt-6 p-4 bg-red-50 rounded-xl border border-red-200 text-right fade-in-up">
                <span class="block text-lg font-bold text-red-700 font-display">“Together, we save lives.”</span>
            </div>
        </div>
    </section>
</div>
<!-- Chat Modal -->
<div id="chatModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-4">
    <div class="flex justify-between items-center mb-2">
      <h3 class="font-bold text-lg" id="chatWith"></h3>
      <button onclick="closeChatModal()" class="text-gray-500">&times;</button>
    </div>
    <div id="chatMessages" class="h-64 overflow-y-auto border rounded p-2 mb-2 bg-gray-50"></div>
    <div class="flex">
      <input id="chatInput" type="text" class="flex-1 border rounded-l px-2 py-1" placeholder="Type a message...">
      <button onclick="sendMessage()" class="bg-red-500 text-white px-4 rounded-r">Send</button>
    </div>
  </div>
</div>
<script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
<script>
let socket = io();
let currentRoom = '';
let myId = {{ session['user_id'] }};
let myType = '{{ session['user_type'] }}';
let chatWithId = null;
let chatWithType = null;
function openChatModal(senderId, senderType, receiverId, receiverType, receiverName) {
    document.getElementById('chatModal').classList.remove('hidden');
    document.getElementById('chatWith').innerText = 'Chat with ' + receiverName;
    chatWithId = receiverId;
    chatWithType = receiverType;
    let ids = [senderId + '-' + senderType, receiverId + '-' + receiverType].sort().join('-');
    currentRoom = ids;
    socket.emit('join_room', {room: currentRoom});
    loadChatHistory(senderId, senderType, receiverId, receiverType);
}
function closeChatModal() {
    document.getElementById('chatModal').classList.add('hidden');
    document.getElementById('chatMessages').innerHTML = '';
    document.getElementById('chatInput').value = '';
}
function sendMessage() {
    let msg = document.getElementById('chatInput').value.trim();
    if (!msg) return;
    socket.emit('send_message', {
        sender_id: myId,
        sender_type: myType,
        receiver_id: chatWithId,
        receiver_type: chatWithType,
        message: msg,
        room: currentRoom
    });
    document.getElementById('chatInput').value = '';
}
socket.on('receive_message', function(data) {
    console.log('Received message:', data); // Debugging line
    
    // Only show notification if the current user is the recipient
    if (myId == data.receiver_id && myType == data.receiver_type) {
        // Always show browser notification with sound and title flash
        showNotification(data.sender_name, data.message);
        
        // Show toastr notification
        if (typeof toastr !== 'undefined') {
            toastr.options = {
                "closeButton": true,
                "debug": false,
                "positionClass": "toast-top-center",
                "timeOut": "5000"
            };
            toastr.info('New message from ' + data.sender_name + ': ' + data.message);
        }
    }
    let chatBox = document.getElementById('chatMessages');
    let isMine = (data.sender_id == myId && data.sender_type == myType);
    let align = isMine ? 'text-right' : 'text-left';
    let color = isMine ? 'bg-red-100' : 'bg-gray-200';
    chatBox.innerHTML += `<div class="my-1 ${align}"><span class="inline-block ${color} px-2 py-1 rounded">${data.message}</span><br><span class="text-xs text-gray-400">${data.timestamp}</span></div>`;
    chatBox.scrollTop = chatBox.scrollHeight;
});
function loadChatHistory(senderId, senderType, receiverId, receiverType) {
    fetch(`/chat/history?user1=${senderId}&type1=${senderType}&user2=${receiverId}&type2=${receiverType}`)
        .then(res => res.json())
        .then(data => {
            let chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = '';
            data.forEach(msg => {
                let isMine = (msg.sender_id == myId && msg.sender_type == myType);
                let align = isMine ? 'text-right' : 'text-left';
                let color = isMine ? 'bg-red-100' : 'bg-gray-200';
                chatBox.innerHTML += `<div class="my-1 ${align}"><span class="inline-block ${color} px-2 py-1 rounded">${msg.message}</span><br><span class="text-xs text-gray-400">${msg.timestamp}</span></div>`;
            });
            chatBox.scrollTop = chatBox.scrollHeight;
        });
}
</script>
{% endblock %} 